<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kafka Messages</title>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" as="script">
    <style>
        body {
            background: radial-gradient(#0202a8, #0000fb);
            color: #fff;
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            font-weight: bold;
        }

        nav {
            height: 25vh;
        }

        main {
            width: 100%;
            height: 70vh;
            display: flex;
        }

        footer {
            height: 5vh;
        }

        .nav_logo {
            height: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.75vw;
            color: yellow;
        }

        .nav_logo>img {
            height: 70%;
            padding: 0.5vw;
        }

        .navlower {
            height: 50%;
            font-size: 3vw;
            display: flex;
            align-items: center;
            justify-content: center;
            color: yellow;
        }

        .navlower>img {
            height: 6vw;
            padding: 0 6vw;
        }

        table {
            height: 100%;
            width: 60vw;
            margin: auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        tbody {
            width: 100%;
        }

        .row {
            width: 100%;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            font-size: 8vh;
            will-change: transform, opacity;
        }

        .row>td>img {
            height: 15vh;
            border-radius: 10%;
            border: 0.5vh solid rgb(97, 93, 93);
        }

        .error, .success, .normal {
            margin: auto;
            font-size: 6vh;
            text-align: center;
            will-change: transform, opacity;
        }

        .error {
            color: #ff0000;
        }

        .success {
            color: #00ff00;
        }

        footer>img {
            height: 90%;
            margin-left: 10px;
        }

        #disclaimer {
            display: none;
        }
    </style>
</head>

<body>
    <nav>
        <div class="nav_logo">
            <img src="{{ url_for('static', filename='img/giventures-logo.png') }}" alt="">
            <div id="disclaimer">Your name will not be displayed if your dataset has not been created</div>
            <img src="{{ url_for('static', filename='img/abesit-logo.png') }}" alt="">
        </div>
        <div class="navlower">
            <img src="{{ url_for('static', filename='img/camera-logo.png') }}" alt="">
            <div>PLEASE LOOK INTO THE CAMERA</div>
            <img src="{{ url_for('static', filename='img/camera-logo.png') }}" alt="">
        </div>
    </nav>
    <main>
        <table>
            <tbody id="rows"></tbody>
        </table>
    </main>
    <footer>
        <img src="{{ url_for('static', filename='img/nvidia-logo.png') }}" alt="">
    </footer>

    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        function getCurrentTimestamp() {
            const now = new Date();

            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
            const day = String(now.getDate()).padStart(2, '0');

            let hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const milliseconds = String(now.getMilliseconds()).padStart(3, '0');

            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12;
            hours = String(hours).padStart(2, '0');

            return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}.${milliseconds} ${ampm}`;
        }

        const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
        let lastUpdate = Date.now();
        const clearIntervalTime = 15000;
        let errorMessage = '', successMessage = '';
        let isErrorPersisted = false, isSuccessPersisted = false;

        socket.on('new_message', data => {
            if (data.message.length > 0) {
                // pull out just the keys
                const ids = data.message.map(item => Object.keys(item)[0]);
                console.log(getCurrentTimestamp(), ids);
            }

            const error = data.message.find(m => m.ERROR);
            const success = data.message.find(m => m.SUCCESS);

            if (error) {
                errorMessage = error.ERROR;
                isErrorPersisted = true;
                isSuccessPersisted = false;
                successMessage = '';
            } else if (success) {
                successMessage = success.SUCCESS;
                isSuccessPersisted = true;
                isErrorPersisted = false;
                errorMessage = '';

                setTimeout(() => isSuccessPersisted = false, successMessage.includes("Getting Started") ? 120000 : 5000);
            } else if (data.message.length) {
                isErrorPersisted = false;
                errorMessage = '';
            }

            requestAnimationFrame(() => {
                if (isErrorPersisted) updateMessage([{ ERROR: errorMessage }], 'error');
                else if (isSuccessPersisted) updateMessage([{ SUCCESS: successMessage }], 'success');
                else updateMessage(data.message, 'normal');
                lastUpdate = Date.now();
            });
        });

        function updateMessage(message, type) {
            const container = document.getElementById('rows');
            container.innerHTML = '';

            message.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'row';
                const key = Object.keys(item)[0];
                const val = item[key];

                if (key === 'SUCCESS' || key === 'ERROR') {
                    const cell = document.createElement('td');
                    const span = document.createElement('span');
                    span.textContent = val;
                    span.className = key.toLowerCase();
                    cell.colSpan = 2;
                    cell.appendChild(span);
                    row.appendChild(cell);
                } else {
                    const imageCell = document.createElement('td');
                    const img = document.createElement('img');
                    img.src = "data:image/jpg;base64," + val;
                    imageCell.appendChild(img);

                    const textCell = document.createElement('td');
                    const span = document.createElement('span');
                    span.textContent = key;
                    span.className = 'normal';
                    textCell.appendChild(span);

                    row.appendChild(textCell);
                    row.appendChild(imageCell);
                }

                container.appendChild(row);
            });
        }

        setInterval(() => socket.emit('check_updates'), 300);
        setInterval(() => {
            if (!isErrorPersisted && !isSuccessPersisted && Date.now() - lastUpdate > clearIntervalTime) {
                updateMessage([], 'normal');
            }
        }, 1000);
    </script>
</body>

</html>
